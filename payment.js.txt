// –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –æ–ø–ª–∞—Ç—ã

let paymentTimer;
let remainingTime = 600; // 10 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
let currentBooking = null;

document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    const currentUser = checkAuth();
    if (!currentUser) {
        showMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
        setTimeout(() => window.location.href = 'auth.html', 2000);
        return;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const savedBooking = sessionStorage.getItem('currentBooking');
    if (!savedBooking) {
        showMessage('–î–∞–Ω–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
        setTimeout(() => window.location.href = 'booking.html', 2000);
        return;
    }
    
    currentBooking = JSON.parse(savedBooking);
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    fillPaymentInfo();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
    startPaymentTimer();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é —á–µ–∫–±–æ–∫—Å–∞
    const paidCheckbox = document.getElementById('paidCheckbox');
    const confirmBtn = document.getElementById('confirmPaymentBtn');
    
    paidCheckbox.addEventListener('change', function() {
        confirmBtn.disabled = !this.checked;
    });
});

function fillPaymentInfo() {
    if (!currentBooking) return;
    
    // –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã
    document.getElementById('paymentAmount').textContent = 
        currentBooking.prepayment.toLocaleString() + ' ‚ÇΩ';
    
    // –ö–æ–¥ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('bookingCode').textContent = 
        currentBooking.booking_code || '#B-' + new Date().getFullYear() + '-' + currentBooking.id.toString().padStart(6, '0');
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –¥–ª—è –¥–µ–º–æ
    const randomCard = generateRandomCardNumber();
    document.getElementById('cardNumber').textContent = randomCard;
}

function startPaymentTimer() {
    updateTimerDisplay();
    
    paymentTimer = setInterval(() => {
        remainingTime--;
        updateTimerDisplay();
        
        if (remainingTime <= 0) {
            clearInterval(paymentTimer);
            showPaymentExpired();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(remainingTime / 60);
    const seconds = remainingTime % 60;
    
    document.getElementById('paymentTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏ –º–∞–ª–æ–º –≤—Ä–µ–º–µ–Ω–∏
    if (remainingTime <= 60) {
        document.getElementById('paymentTimer').style.color = '#ff4757';
    }
}

function showPaymentExpired() {
    showMessage('–í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ. –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.', 'error');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const bookings = BeautyProData.getBookings();
    const bookingIndex = bookings.findIndex(b => b.id === currentBooking.id);
    
    if (bookingIndex !== -1) {
        bookings[bookingIndex].status = 'cancelled';
        BeautyProData.updateBookings(bookings);
    }
    
    setTimeout(() => {
        window.location.href = 'booking.html';
    }, 3000);
}

function moveCardDigit(current) {
    const currentInput = document.getElementById(`cardDigit${current}`);
    const nextInput = document.getElementById(`cardDigit${current + 1}`);
    
    if (currentInput.value && nextInput) {
        nextInput.focus();
    }
}

function confirmPayment() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–º–µ—á–µ–Ω –ª–∏ —á–µ–∫–±–æ–∫—Å
    const paidCheckbox = document.getElementById('paidCheckbox');
    if (!paidCheckbox.checked) {
        showMessage('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ, —á—Ç–æ –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—É', 'error');
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–≤–µ–¥–µ–Ω—ã –ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∫–∞—Ä—Ç—ã
    let cardDigits = '';
    for (let i = 1; i <= 4; i++) {
        const digit = document.getElementById(`cardDigit${i}`).value;
        if (!digit || isNaN(digit)) {
            showMessage('–í–≤–µ–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∫–∞—Ä—Ç—ã', 'error');
            document.getElementById(`cardDigit${i}`).focus();
            return;
        }
        cardDigits += digit;
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
    clearInterval(paymentTimer);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    const bookings = BeautyProData.getBookings();
    const bookingIndex = bookings.findIndex(b => b.id === currentBooking.id);
    
    if (bookingIndex !== -1) {
        bookings[bookingIndex].status = 'confirmed';
        bookings[bookingIndex].payment_method = 'card_transfer';
        bookings[bookingIndex].last_card_digits = cardDigits;
        bookings[bookingIndex].paid_at = new Date().toISOString();
        
        BeautyProData.updateBookings(bookings);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä—É (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –±–æ—Ç–∞)
        sendNotificationToMaster(bookings[bookingIndex]);
    }
    
    showMessage('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å...', 'success');
    
    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    setTimeout(() => {
        sessionStorage.setItem('confirmedBookingId', currentBooking.id);
        window.location.href = 'booking-success.html';
    }, 1500);
}

function sendNotificationToMaster(booking) {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –≤—ã–∑–æ–≤ –∫ Telegram –±–æ—Ç—É
    // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
    
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    
    const master = BeautyProData.getMasterById(booking.master_id);
    const service = BeautyProData.getServiceById(booking.service_id);
    const client = BeautyProData.getUsers().find(u => u.id === booking.client_id);
    
    if (master && service && client) {
        const notification = {
            id: notifications.length + 1,
            master_id: master.id,
            type: 'new_booking',
            message: `üìÖ –ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å!\n–ö–ª–∏–µ–Ω—Ç: ${client.name}\n–£—Å–ª—É–≥–∞: ${service.name}\n–î–∞—Ç–∞: ${booking.date} ${booking.time}`,
            created_at: new Date().toISOString(),
            is_read: false
        };
        
        notifications.push(notification);
        localStorage.setItem('notifications', JSON.stringify(notifications));
        
        console.log('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω–æ:', notification);
    }
}

function goBack() {
    window.history.back();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
function generateRandomCardNumber() {
    const prefixes = ['2200', '2201', '2202', '2203', '2204'];
    const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
    
    let cardNumber = prefix;
    for (let i = 0; i < 12; i++) {
        if (i % 4 === 0) cardNumber += ' ';
        cardNumber += Math.floor(Math.random() * 10);
    }
    
    return cardNumber.trim();
}